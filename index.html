<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏û‡∏π‡∏î ‚Üí ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏´‡∏ç‡πà</title>

<!-- PWA -->
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
  body{
    margin:0;
    background:black;
    color:white;
    font-family:system-ui,sans-serif;
    height:100vh;
    display:flex;
    flex-direction:column;
  }
  #text{
    flex:1;
    padding:24px;
    font-size:96px;   /* ‡πÉ‡∏´‡∏ç‡πà‡∏°‡∏≤‡∏Å */
    line-height:1.25;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    word-break:break-word;
  }
  #status{
    text-align:center;
    font-size:36px;
    font-weight:bold;
    padding:10px;
    color:#00ff00;
    display:none;
  }
  .controls{
    padding:16px;
  }
  button{
    width:100%;
    font-size:34px;
    padding:24px;
    border:none;
    border-radius:18px;
    font-weight:bold;
  }
  #mic{ background:#1db954; color:black; }
</style>
</head>

<body>

<div id="text"></div>
<div id="status">üé§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‚Ä¶ <span id="timer">00:00</span></div>

<div class="controls">
  <button id="mic">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î</button>
</div>

<script>
/* ===== Speech ===== */
const textDiv = document.getElementById("text");
const statusDiv = document.getElementById("status");
const timerSpan = document.getElementById("timer");
const micBtn = document.getElementById("mic");

const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;

const recog = new SpeechRecognition();
recog.lang = "th-TH";
recog.continuous = true;
recog.interimResults = false;

let listening=false;
let seconds=0;
let blinkInterval, timeInterval, silenceTimer;

function fmt(sec){
  const m=String(Math.floor(sec/60)).padStart(2,"0");
  const s=String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}

micBtn.onclick=()=>{
  listening ? recog.stop() : recog.start();
};

recog.onstart=()=>{
  listening=true;
  micBtn.innerText="‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î";
  micBtn.style.background="#ff5252";

  seconds=0;
  timerSpan.innerText="00:00";
  statusDiv.style.display="block";

  blinkInterval=setInterval(()=>{
    statusDiv.style.visibility=
      statusDiv.style.visibility==="hidden"?"visible":"hidden";
  },800);

  timeInterval=setInterval(()=>{
    seconds++;
    timerSpan.innerText=fmt(seconds);
  },1000);
};

recog.onresult=(e)=>{
  const txt=e.results[e.results.length-1][0].transcript.trim();

  // ‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏•‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô)
  textDiv.innerText=txt;

  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏ö‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏à‡∏ö
  if (/[.!?]$/.test(txt)) {
    // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
  }

  // ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô 1.2 ‡∏ß‡∏¥ = ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏à‡∏ö
  clearTimeout(silenceTimer);
  silenceTimer=setTimeout(()=>{},1200);
};

recog.onend=()=>{
  listening=false;
  micBtn.innerText="‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î";
  micBtn.style.background="#1db954";
  statusDiv.style.display="none";
  statusDiv.style.visibility="visible";
  clearInterval(blinkInterval);
  clearInterval(timeInterval);
};

/* ===== PWA Service Worker (‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) ===== */
if ("serviceWorker" in navigator) {
  const sw=`
    self.addEventListener('install',e=>{
      e.waitUntil(
        caches.open('talk-pwa').then(c=>c.addAll(['./']))
      );
    });
    self.addEventListener('fetch',e=>{
      e.respondWith(
        caches.match(e.request).then(r=>r||fetch(e.request))
      );
    });
  `;
  const blob=new Blob([sw],{type:"text/javascript"});
  navigator.serviceWorker.register(URL.createObjectURL(blob));
}
</script>

</body>
</html>
