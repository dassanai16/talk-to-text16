<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏û‡∏π‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏´‡∏ç‡πà</title>

<!-- PWA Meta -->
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
  body {
    margin: 0;
    background: black;
    color: white;
    font-family: system-ui, sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  #text {
    flex: 1;
    padding: 20px;
    font-size: 72px;
    line-height: 1.3;
    overflow-y: auto;
    word-break: break-word;
  }
  #status {
    text-align: center;
    font-size: 36px;
    font-weight: bold;
    padding: 10px;
    color: #00ff00;
    display: none;
  }
  .controls {
    display: flex;
    gap: 10px;
    padding: 15px;
  }
  button {
    flex: 1;
    font-size: 30px;
    padding: 22px;
    border: none;
    border-radius: 16px;
    font-weight: bold;
  }
  #mic { background: #1db954; color: black; }
  #clear { background: #b00020; color: white; }
  #access { background: #333; color: white; }
</style>
</head>

<body>

<div id="text"></div>
<div id="status">üé§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‚Ä¶ <span id="timer">00:00</span></div>

<div class="controls">
  <button id="mic">üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î</button>
  <button id="clear">üßπ ‡∏•‡πâ‡∏≤‡∏á</button>
  <button id="access">‚öôÔ∏è ‡πÄ‡∏°‡∏ô‡∏π</button>
</div>

<script>
/* ---------- Speech ---------- */
const textDiv = document.getElementById("text");
const statusDiv = document.getElementById("status");
const timerSpan = document.getElementById("timer");
const micBtn = document.getElementById("mic");

const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;

const recog = new SpeechRecognition();
recog.lang = "th-TH";
recog.continuous = true;
recog.interimResults = false;

let listening = false;
let blinkInterval, timeInterval, silenceTimer;
let seconds = 0;

function formatTime(sec) {
  const m = String(Math.floor(sec / 60)).padStart(2, "0");
  const s = String(sec % 60).padStart(2, "0");
  return `${m}:${s}`;
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á
function startListening() {
  recog.start();
}

// ‡∏´‡∏¢‡∏∏‡∏î‡∏ü‡∏±‡∏á
function stopListening() {
  recog.stop();
}

// toggle ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
micBtn.onclick = () => {
  listening ? stopListening() : startListening();
};

recog.onstart = () => {
  listening = true;
  statusDiv.style.display = "block";
  micBtn.innerText = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î";
  micBtn.style.background = "#ff5252";

  seconds = 0;
  timerSpan.innerText = "00:00";

  blinkInterval = setInterval(() => {
    statusDiv.style.visibility =
      statusDiv.style.visibility === "hidden" ? "visible" : "hidden";
  }, 800);

  timeInterval = setInterval(() => {
    seconds++;
    timerSpan.innerText = formatTime(seconds);
  }, 1000);
};

recog.onresult = (event) => {
  const last = event.results[event.results.length - 1][0].transcript.trim();
  textDiv.innerText += last;

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏ö‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢
  if (/[.!?]$/.test(last)) {
    textDiv.innerText += "\n";
  } else {
    textDiv.innerText += " ";
  }

  textDiv.scrollTop = textDiv.scrollHeight;

  // ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏á‡∏µ‡∏¢‡∏ö
  clearTimeout(silenceTimer);
  silenceTimer = setTimeout(() => {
    textDiv.innerText += "\n";
  }, 1200);
};

recog.onend = () => {
  listening = false;
  statusDiv.style.display = "none";
  statusDiv.style.visibility = "visible";
  micBtn.innerText = "üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î";
  micBtn.style.background = "#1db954";
  clearInterval(blinkInterval);
  clearInterval(timeInterval);
};

/* ---------- Clear (‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á) ---------- */
let clearTimer;
document.getElementById("clear").onmousedown = () => {
  clearTimer = setTimeout(() => textDiv.innerText = "", 1000);
};
document.getElementById("clear").onmouseup =
document.getElementById("clear").onmouseleave = () =>
  clearTimeout(clearTimer);

/* ---------- Accessibility ---------- */
document.getElementById("access").onclick = () => {
  const c = prompt(
    "Accessibility\n1 = XL\n2 = XXL\n3 = ‡∏Ç‡∏≤‡∏ß/‡∏î‡∏≥\n4 = ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á/‡∏î‡∏≥"
  );
  if (c === "1") textDiv.style.fontSize = "72px";
  if (c === "2") textDiv.style.fontSize = "120px";
  if (c === "3") {
    document.body.style.background = "black";
    document.body.style.color = "white";
  }
  if (c === "4") {
    document.body.style.background = "black";
    document.body.style.color = "yellow";
  }
};

/* ---------- PWA Service Worker (‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) ---------- */
if ("serviceWorker" in navigator) {
  const swCode = `
    self.addEventListener('install', e => {
      e.waitUntil(
        caches.open('talk-pwa').then(cache =>
          cache.addAll(['./'])
        )
      );
    });
    self.addEventListener('fetch', e => {
      e.respondWith(
        caches.match(e.request).then(r => r || fetch(e.request))
      );
    });
  `;
  const blob = new Blob([swCode], { type: "text/javascript" });
  const swURL = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swURL);
}
</script>

</body>
</html>
